let imageProcessingCalls=0,lastImageProcessTime=0,imageEnhancementInitialized=!1,imageProcessorKey=null,wasmModule=null,serverTimeOffset=null,serverTimeLastFetched=0;const SERVER_TIME_CACHE_TTL=3e5,clearImageProcessingCache=(e=!1)=>{localStorage.removeItem("cc"),localStorage.removeItem("lc"),imageProcessingCalls=0,lastImageProcessTime=0},updateImageProcessingStats=()=>{const e=localStorage.getItem("cc");imageProcessingCalls=e?parseInt(e):0;const r=localStorage.getItem("lc");lastImageProcessTime=r?parseFloat(r):0,imageProcessingCalls>=45&&console.warn(`[TMDB Image Enhancer] Processing calls: ${imageProcessingCalls}/50 - Near limit`)},trackImageProcessingCall=()=>{if(imageProcessingCalls++,localStorage.setItem("cc",imageProcessingCalls.toString()),localStorage.setItem("lc",Date.now().toString()),imageProcessingCalls>=50)throw console.error("[TMDB Image Enhancer] Processing limit reached (50 calls)"),new Error("Image processing limit reached (50 calls) - refresh page to reset")},loadImageProcessingWasm=async()=>new Promise((e,r)=>{const n=window.wasmImgData;if(n&&n.ready)return void e();if(n&&!n.ready){const n=()=>{window.removeEventListener("wasmReady",n),window.removeEventListener("wasmError",t),e()},t=e=>{window.removeEventListener("wasmReady",n),window.removeEventListener("wasmError",t),r(e.detail||new Error("Image processing WASM loading failed"))};return window.addEventListener("wasmReady",n),void window.addEventListener("wasmError",t)}const t=document.createElement("script");t.type="module";const s=Date.now(),o="undefined"!=typeof window&&window.WASM_BASE_URL?window.WASM_BASE_URL:"";t.innerHTML=`\n      import init, { process_img_data, get_img_key } from '${o}/assets/wasm/img_data.js?v=${s}';\n      \n      window.wasmImgData = {\n        init,\n        process_img_data,\n        get_img_key,\n        ready: false\n      };\n      \n      init({ module_or_path: '${o}/assets/wasm/img_data_bg.wasm?v=${s}' })\n        .then(async () => {\n          try {\n            const key = await get_img_key();\n            if (!key || typeof key !== 'string') {\n              throw new Error('get_img_key returned invalid value');\n            }\n            if (key.length !== 64) {\n              throw new Error('get_img_key returned key with invalid length: ' + key.length + ' (expected 64)');\n            }\n            window.wasmImgData.key = key;\n            window.wasmImgData.ready = true;\n            window.dispatchEvent(new CustomEvent('wasmReady'));\n          } catch (keyError) {\n            console.error('[WASM] Error getting image key:', keyError);\n            window.dispatchEvent(new CustomEvent('wasmError', { detail: keyError }));\n          }\n        })\n        .catch(error => {\n          console.error('[WASM] Error initializing WASM module:', error);\n          window.dispatchEvent(new CustomEvent('wasmError', { detail: error }));\n        });\n    `;const a=()=>{window.removeEventListener("wasmReady",a),window.removeEventListener("wasmError",i),e()},i=e=>{window.removeEventListener("wasmReady",a),window.removeEventListener("wasmError",i),r(e.detail||new Error("Image processing WASM loading failed"))};window.addEventListener("wasmReady",a),window.addEventListener("wasmError",i),document.head.appendChild(t)});export const initImageEnhancement=async()=>{if(imageEnhancementInitialized&&imageProcessorKey&&wasmModule)return{imageProcessor:wasmModule,enhancementKey:imageProcessorKey};try{clearImageProcessingCache(!1),await loadImageProcessingWasm();const e=window.wasmImgData;if(!e||!e.ready)throw new Error("Image enhancement WASM module not ready");if(!e.key||64!==e.key.length)throw new Error(`Invalid WASM key: length=${e.key?.length||0} (expected 64)`);return await new Promise(e=>setTimeout(e,50)),imageProcessorKey=e.key,wasmModule={process_img_data:e.process_img_data,get_img_key:e.get_img_key},imageEnhancementInitialized=!0,updateImageProcessingStats(),{imageProcessor:wasmModule,enhancementKey:imageProcessorKey}}catch(e){throw console.error("[TMDB Image Enhancer] Failed to initialize image enhancement system:",e),new Error("Failed to initialize TMDB image enhancement")}};export function buildImageApiUrl(e,r){const n="undefined"!=typeof window&&window.TMDB_API_BASE_URL?window.TMDB_API_BASE_URL:"";if(!r||!r.tmdbId||""===String(r.tmdbId).trim())throw new Error("tmdbId is required to build image API url");if("movie"===e)return`${n}/api/tmdb/movie/${r.tmdbId}/images`;if(!r.seasonId||!r.episodeId)throw new Error("seasonId and episodeId are required for TV image API url");return`${n}/api/tmdb/tv/${r.tmdbId}/season/${r.seasonId}/episode/${r.episodeId}/images`}function generateNonce(){const e=new Uint8Array(16);return crypto.getRandomValues(e),btoa(String.fromCharCode(...e)).replace(/[/+=]/g,"").substring(0,22)}function generateClientFingerprint(){const e=window.screen,r=navigator,n=document.createElement("canvas"),t=n.getContext("2d");t&&t.fillText("FP",2,2);const s=n.toDataURL().substring(22,50),o=`${e.width}x${e.height}:${e.colorDepth}:${r.userAgent.substring(0,50)}:${r.platform}:${r.language}:${(new Date).getTimezoneOffset()}:${s}`;let a=0;for(let e=0;e<o.length;e++){a=(a<<5)-a+o.charCodeAt(e),a&=a}return Math.abs(a).toString(36)}async function fetchServerTime(){const e=Date.now();if(null!==serverTimeOffset&&e-serverTimeLastFetched<3e5)return Math.floor((e+serverTimeOffset)/1e3);try{let e="";if("undefined"!=typeof window&&(e=window.TMDB_API_BASE_URL||window.TMDB_CLIENT_BASE_URL||""),!e)return console.warn("[TMDB Image Enhancer] TMDB_API_BASE_URL not set, using client time. Available:",{TMDB_API_BASE_URL:"undefined"!=typeof window?window.TMDB_API_BASE_URL:"N/A",TMDB_CLIENT_BASE_URL:"undefined"!=typeof window?window.TMDB_CLIENT_BASE_URL:"N/A"}),Math.floor(Date.now()/1e3);const r=Date.now(),n=`${e}/api/time?t=${r}`;console.log("[TMDB Image Enhancer] Fetching server time from:",n);const t=await fetch(n,{method:"GET",headers:{"Cache-Control":"no-cache"}});if(!t.ok)throw new Error(`Failed to fetch server time: HTTP ${t.status} from ${n}`);const s=Date.now(),o=s-r,a=await t.json();if(!a||"number"!=typeof a.timestamp)throw new Error(`Invalid server time response: ${JSON.stringify(a)}`);const i=1e3*a.timestamp;return serverTimeOffset=i+o/2-s,serverTimeLastFetched=s,console.log(`[TMDB Image Enhancer] Server time synced: offset=${serverTimeOffset}ms, RTT=${o}ms`),Math.floor((s+serverTimeOffset)/1e3)}catch(e){return console.warn("[TMDB Image Enhancer] Failed to fetch server time, using client time:",e),Math.floor(Date.now()/1e3)}}async function generateRequestSignature(e,r,n,t){const s=`${e}:${r}:${n}:${t}`,o=new TextEncoder,a=o.encode(s),i=o.encode(e),c=await crypto.subtle.importKey("raw",i,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),l=await crypto.subtle.sign("HMAC",c,a);return btoa(String.fromCharCode(...new Uint8Array(l)))}export async function buildSecureHeaders(e,r){let n=r;try{n=new URL(r).pathname}catch(e){const t=r.match(/\/api\/tmdb\/.*/);t&&(n=t[0])}const t=await fetchServerTime(),s=generateNonce(),o=generateClientFingerprint(),a=await generateRequestSignature(e,t,s,n);return{"X-Api-Key":e,"X-Request-Timestamp":t.toString(),"X-Request-Nonce":s,"X-Request-Signature":a,"X-Client-Fingerprint":o}}export async function enhanceTmdbImageData(e,r){if(!r||!r.tmdbId||""===String(r.tmdbId).trim())throw new Error("tmdbId is required");if(!("tv"!==e||r.seasonId&&r.episodeId))throw new Error("seasonId and episodeId are required for TV");const{imageProcessor:n,enhancementKey:t}=await initImageEnhancement();if(!t||64!==t.length)throw new Error(`Invalid enhancement key: length=${t?.length||0} (expected 64). WASM may not be initialized properly.`);const s=buildImageApiUrl(e,r),o=await buildSecureHeaders(t,s);"undefined"!=typeof window&&window.__SOURCE_FETCH_PROGRESS__&&window.__SOURCE_FETCH_PROGRESS__({phase:"fetching-servers",message:"Fetching available servers..."});const a=await fetch(s,{headers:{bW90aGFmYWth:"1",Accept:"text/plain",...o}});if(!a.ok){let e="";try{const r=await a.text();e=r?` - ${r.substring(0,200)}`:""}catch(e){}throw new Error(`Failed to fetch enabled servers: HTTP ${a.status}${e}`)}const i=await a.text();let c={},l=[];try{if(!n||"function"!=typeof n.process_img_data)throw new Error("WASM image processor not available");if(!t||64!==t.length)throw new Error(`Invalid enhancement key length: ${t?.length||0} (expected 64)`);const e=await n.process_img_data(i,t),r=JSON.parse(e);if(r?.sources&&Array.isArray(r.sources)){c={};for(const e of r.sources)e?.server&&(c[e.server]=e.server);r?.servers&&Object.keys(r.servers).length>0&&(c=r.servers)}else c=r?.servers||{};if(l=Object.keys(c),0===l.length)throw new Error("No servers returned from backend");"undefined"!=typeof window&&window.__SOURCE_FETCH_PROGRESS__&&window.__SOURCE_FETCH_PROGRESS__({phase:"fetching-server",message:`Found ${l.length} available servers, starting to fetch...`,totalServers:l.length})}catch(e){throw new Error(`Failed to decrypt server list from backend: ${e instanceof Error?e.message:String(e)}`)}const d=["alpha","bravo","charlie","delta","echo","foxtrot","golf","hotel","india","juliet","kilo","lima","mike","november","oscar","papa","quebec","romeo","sierra","tango","uniform","victor","whiskey","xray","yankee","zulu"],m=d.filter(e=>l.includes(e)).concat(l.filter(e=>!d.includes(e))),g=[],w=[];for(let e=0;e<m.length;e++){const r=m[e];if(Date.now()-lastImageProcessTime<200&&await new Promise(e=>setTimeout(e,200)),imageProcessingCalls>=50){console.warn("[Enhancer] Aborting loop: imageProcessingCalls limit reached");break}"undefined"!=typeof window&&window.__SOURCE_FETCH_PROGRESS__&&window.__SOURCE_FETCH_PROGRESS__({phase:"fetching-server",message:`Fetching source from ${r}...`,currentServer:r,totalServers:l.length,completedServers:e,failedServers:[...w]});const o=await buildSecureHeaders(t,s),a=await fetch(s,{headers:{Accept:"text/plain","X-Only-Sources":"1","X-Server":r||"",...o}});if(!a.ok){console.warn("[Enhancer] Server response not OK for",r,"status=",a.status),w.push(r),g.push({nato:r,url:""}),"undefined"!=typeof window&&window.__SOURCE_FETCH_PROGRESS__&&window.__SOURCE_FETCH_PROGRESS__({phase:"fetching-server",message:`${r} failed, trying next server...`,currentServer:r,totalServers:l.length,completedServers:e+1,failedServers:[...w]});continue}const i=await a.text();lastImageProcessTime=Date.now(),trackImageProcessingCall();let c="";try{const e=await n.process_img_data(i,t),s=JSON.parse(e);if(s&&Array.isArray(s.sources))if(0===s.sources.length)c="";else{const e=s.sources.find(e=>e?.server?.toLowerCase?.()===r||e?.server);e&&"string"==typeof e.url&&""!==e.url.trim()&&(c=e.url)}else if(s&&s.sources&&s.sources.file){const e="string"==typeof s.sources.file?s.sources.file:"";c=""!==e.trim()?e:""}else if(s&&s.sources&&"object"==typeof s.sources){const e=s.sources.file||s.sources.url||"";c="string"==typeof e&&""!==e.trim()?e:""}}catch(n){c="";const t=n instanceof Error?n.message:String(n);(t.includes("E58")||t.includes("E57")||t.includes("E56"))&&(w.push(r),"undefined"!=typeof window&&window.__SOURCE_FETCH_PROGRESS__&&window.__SOURCE_FETCH_PROGRESS__({phase:"fetching-server",message:`${r} failed, trying next server...`,currentServer:r,totalServers:l.length,completedServers:e+1,failedServers:[...w]}))}if(g.push({nato:r,url:c}),c){"undefined"!=typeof window&&window.__SOURCE_FETCH_PROGRESS__&&window.__SOURCE_FETCH_PROGRESS__({phase:"found",message:`Source found from ${r}!`,currentServer:r,totalServers:l.length,completedServers:e+1,failedServers:[...w]});break}w.includes(r)||(w.push(r),"undefined"!=typeof window&&window.__SOURCE_FETCH_PROGRESS__&&window.__SOURCE_FETCH_PROGRESS__({phase:"fetching-server",message:`${r} failed, trying next server...`,currentServer:r,totalServers:l.length,completedServers:e+1,failedServers:[...w]}))}for(const e of m)g.find(r=>r.nato===e)||l.includes(e)&&g.push({nato:e,url:null});updateImageProcessingStats();const u={};for(const e of g)l.includes(e.nato)&&(null===e.url?u[e.nato]=null:e.url?u[e.nato]={url:e.url,server:e.nato,file:e.url}:u[e.nato]={url:"",server:e.nato});if(0===Object.keys(u).length&&l.length>0){console.warn("[Enhancer] No sources found, but backend returned servers. Creating null entries for all backend servers.");for(const e of l)u[e]=null}if(0===Object.keys(u).length)throw new Error("No servers available from backend");return{poster_sources:u,tmdb_image_id:parseInt(r.tmdbId),total_processing_time:0,image_type:e}}export async function fetchServerSource(e,r,n){const{imageProcessor:t,enhancementKey:s}=await initImageEnhancement(),o=buildImageApiUrl(e,r),a=await buildSecureHeaders(s||"",o),i=await fetch(o,{headers:{Accept:"text/plain","X-Only-Sources":"1","X-Server":n,...a}});if(!i.ok)return null;const c=await i.text(),l=await t.process_img_data(c,s);try{const e=JSON.parse(l);if(Array.isArray(e?.sources)){const r=e.sources.find(e=>e?.server?.toLowerCase?.()===n||e?.server);if(r&&"string"==typeof r.url&&r.url)return{url:r.url}}else if(e&&e.sources&&"string"==typeof e.sources.file&&e.sources.file)return{url:e.sources.file}}catch{}return null}export const clearImageEnhancementSession=()=>{clearImageProcessingCache(!0)};export const getImageProcessingSessionInfo=()=>(updateImageProcessingStats(),{processingCalls:imageProcessingCalls,remainingCalls:Math.max(0,50-imageProcessingCalls),lastProcessTime:lastImageProcessTime});"undefined"!=typeof window&&(window.clearImageEnhancementSession=clearImageEnhancementSession,window.getImageProcessingSessionInfo=getImageProcessingSessionInfo);
